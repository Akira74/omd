Summary:        OMD - OpenSource Monitoring Distribution
Name:	        omd-%{version}
Version:        %{version}
Release:        1
License:        GPL
Group:          Atlas
Source:         %{name}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root
Requires:	

#%define _missing_doc_files_terminate_build 0
#%define _unpackaged_files_terminate_build 0

%description
Open Source Monitoring Distribution, containing Nagios,
the Nagios plugins, Check_MK, Livestatus, Multisite,
PNP4Nagios, NagVis, and other addons. Please visit
http://omdistro.org/.

%prep
%setup -q -n omd-%{version}

%build
make PACKAGES=omd -j 4
make PACKAGES=omd pack

%install
mkdir -p $RPM_BUILD_ROOT
tar xzf omd-bin-%{version}.tar.gz -C $RPM_BUILD_ROOT
# Remove all global symbolic links from package. They are shared
# among all versions and must be handled in %post und %postun
# in order to avoid RPM conflicts
rm -f $RPM_BUILD_ROOT/opt/omd/versions/default
rm -f $RPM_BUILD_ROOT/omd
rm -f $RPM_BUILD_ROOT/usr/bin/omd
rm -f $RPM_BUILD_ROOT/usr/share/man/man8/omd.8.gz
rm -f $RPM_BUILD_ROOT/@APACHE_CONFDIR@/*
rm -f $RPM_BUILD_ROOT/etc/init.d/omd

%files
/opt/omd
#/usr/share/man/man8/*
#@APACHE_CONFDIR@/*
#/etc/init.d/*
# %dir %attr(770,root,root) /opt/omd/versions/%{version}/skel/var/check_mk/logwatch
# %dir %attr(770,root,root) /opt/omd/versions/%{version}/skel/var/check_mk/web
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/etc/nagvis
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/etc/nagvis/maps
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/etc/nagvis/maps/*
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/etc/nagvis/automaps
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/etc/nagvis/automaps/*
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/etc/nagvis/nagvis.ini.php
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/etc/nagvis/auth.db
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/var/nagvis/userfiles/images/maps
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/var/nagvis/userfiles/images/maps/*
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/var/nagvis/userfiles/images/shapes
# %attr(664,root,root)      /opt/omd/versions/%{version}/skel/var/nagvis/userfiles/images/shapes/*
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/tmp/nagvis
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/tmp/nagvis/share
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/tmp/nagvis/tmpl/cache
# %dir %attr(775,root,root) /opt/omd/versions/%{version}/skel/tmp/nagvis/tmpl/compile
# %attr(4755,root,root) /opt/omd/versions/%{version}/lib/nagios/plugins/check_icmp

%pre
groupadd -r omd 2>/dev/null || true
ln -sfn /opt/omd /omd

%post
echo "New default version is %{version}."
ln -sfn "%{version}" /omd/versions/default
ln -sfn /omd/versions/default/bin/omd /usr/bin/omd
ln -sfn /omd/versions/default/share/man/man8/omd.8.gz /usr/share/man/man8/omd.8.gz
ln -sfn /omd/versions/default/etc/init.d/omd /etc/init.d/omd
ln -sfn /omd/versions/default/etc/apache2/conf.d/zzz_omd.conf /etc/apache2/conf.d/zzz_omd.conf
chkconfig omd on

%preun

%postun
rm -f /omd/versions/default
v=$(ls -A /omd/versions 2>/dev/null| sort -n | tail -n 1)
if [ -n "$v" ]
then
    echo "New default version is $v"
    ln -sfn "$v" /omd/versions/default
else
    echo "Removing system group 'omd'"
    groupdel omd
    echo "Removing symbolic links"
    rm -f /usr/bin/omd
fi
