#!/bin/bash

# FIXME: Do not hardcode this here
OMD_PHYSICAL_BASE=/opt/omd

version_specific_omd ()
{
    local VERSION="$1"
    shift
    exec /omd/versions/$VERSION/bin/omd "$@"
}

check_site () {
    if [ -z $1 ] || [ ! -d "/omd/sites/$1" ]; then
        echo "Error: The specified site \"$1\" does not exist"
        exit 1
    fi
}

check_version () {
    if [ -z "$1" ] || [ ! -d "/omd/versions/$1" ]; then
        echo "Error: The specified version \"$1\" does not exist"
        exit 1
    fi
}

list_sites () {
    ( cd /omd/sites ; ls)
}

COMMAND=$1
case "$COMMAND" in 
    rm|cp|mv)
        SITE="$2"
        check_site "$SITE"
        exec /omd/sites/$SITE/bin/omd "$@"
    ;;
    start|stop|restart|reload|status)
        if [ "$2" ] ; then
            check_site "$2"
            exec su - "$2" -c "/omd/sites/$2/bin/omd $@"
        else
            for site in $(list_sites) ; do
                su - "$site" -c "/omd/sites/$site/bin/omd $@"
            done
        fi
    ;;
    create|update)
        VERSION="${3:-default}"
        [ "$COMMAND" = "update" ] && check_site "$2"
        check_version "$VERSION"
        exec /omd/versions/$VERSION/bin/omd "$@"
    ;;
    uninstall)
	$0 stop
        for site in $(list_sites) ; do
            omd rm $site
        done
	exec /omd/versions/default/bin/omd uninstall
    ;;
    *)
        exec /omd/versions/default/bin/omd "$@"
    ;;
esac

