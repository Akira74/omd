From 380f42d0e008e5aa0641d6d39619619d594cf384 Mon Sep 17 00:00:00 2001
From: Gerhard Lausser <gerhard.lausser@consol.de>
Date: Thu, 15 Mar 2012 16:44:26 +0100
Subject: [PATCH] Fix a bug in livestatus module and add the attribute host.event_handler (needed by Thruk)

---
 shinken/modules/livestatus_broker/mapping.py |    7 ++++-
 test/test_livestatus.py                      |   33 ++++++++++++++++++++++++++
 2 files changed, 38 insertions(+), 2 deletions(-)

diff --git a/shinken/modules/livestatus_broker/mapping.py b/shinken/modules/livestatus_broker/mapping.py
index be4cd5e..d3e6516 100644
--- a/shinken/modules/livestatus_broker/mapping.py
+++ b/shinken/modules/livestatus_broker/mapping.py
@@ -333,7 +333,10 @@ livestatus_attribute_map = {
             'datatype': list,
             # 2|omdadmin|hdodo = id|author|comment
         },
-
+        'event_handler': {
+            'description': 'Nagios command used as event handler',
+            'function': lambda item, req: item.event_handler.get_name(),
+        },
         'event_handler_enabled': {
             'description': 'Whether event handling is enabled (0/1)',
             'function': lambda item, req: item.event_handler_enabled,
@@ -856,7 +859,7 @@ livestatus_attribute_map = {
         },
         'event_handler': {
             'description': 'Nagios command used as event handler',
-            'function': lambda item, req: "",  # REPAIRME
+            'function': lambda item, req: item.event_handler.get_name(),
         },
         'event_handler_enabled': {
             'description': 'Whether and event handler is activated for the service (0/1)',
diff --git a/test/test_livestatus.py b/test/test_livestatus.py
index 663eaf4..d97fbea 100755
--- a/test/test_livestatus.py
+++ b/test/test_livestatus.py
@@ -38,6 +38,7 @@ from shinken.brok import Brok
 from shinken.objects.timeperiod import Timeperiod
 from shinken.objects.module import Module
 from shinken.comment import Comment
+from shinken.util import from_bool_to_int
 
 sys.setcheckinterval(10000)
 
@@ -1905,6 +1906,38 @@ test_host_0;test_ok_0
 """)
 
 
+    def test_host_and_service_eventhandler(self):
+        self.print_header()
+        now = time.time()
+        self.update_broker()
+        host = self.sched.hosts.find_by_name("test_host_0")
+        svc = self.sched.services.find_srv_by_name_and_hostname("test_host_0", "test_ok_0")
+        self.assert_(host.event_handler_enabled == True)
+        self.assert_(svc.event_handler_enabled == True)
+
+        request = """GET services
+Columns: host_name service_description event_handler_enabled event_handler
+Filter: host_name = test_host_0
+Filter: description = test_ok_0
+OutputFormat: csv
+"""
+        response, keepalive = self.livestatus_broker.livestatus.handle_request(request)
+        print response
+        self.assert_("""test_host_0;test_ok_0;1;eventhandler
+""")
+        self.assert_(response == "%s;%s;%d;%s\n" % (svc.host_name, svc.service_description, from_bool_to_int(svc.event_handler_enabled), svc.event_handler.get_name()))
+
+        request = """GET hosts
+Columns: host_name event_handler_enabled event_handler
+Filter: host_name = test_host_0
+OutputFormat: csv
+"""
+        response, keepalive = self.livestatus_broker.livestatus.handle_request(request)
+        print response
+        self.assert_("""test_host_0;1;eventhandler
+""")
+        self.assert_(response == "%s;%d;%s\n" % (host.host_name, from_bool_to_int(host.event_handler_enabled), host.event_handler.get_name()))
+
 
     def test_is_executing(self):
         self.print_header()
-- 
1.7.1

